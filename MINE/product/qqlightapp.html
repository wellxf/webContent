<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta itemprop="name" content="挖藕智能科技轻app" />
    <meta itemprop="description" content="挖藕智能科技的qq物联轻app页面" />
    <meta itemprop="image" content="http://wa-ou.com/images/lightapp-logo.png" />
    <title>我的开关</title>
    <meta name="viewport" content="width=600, minimum-scale=1.0, maximum-scale=1.0, target-densitydpi=device-dpi, user-scalable=0" />
    <base />
    <style>

        body {
        	font-family: "Microsoft Yahei", "\5FAE\8F6F\96C5\9ED1", arial, sans-serif;

        }
        
        * {
        	margin: 0;
        	padding: 0
        }
        
        
        ul, ol {
        	padding-left: 0;
        	list-style-type: none
        }
        
        a {
        	text-decoration: none
        }
        
        div#container {
        	width: 600px;
        }
        
        div#head {
        	position: absolute;
        	height: 400px;
            width: 600px;
            border-style: solid;
            border-width: 0px 0px 1px 0px;
            overflow-y: scroll
        }
        
        div#middle {
        	position: absolute;
        	height: 400px;
            width: 600px;
        	bottom: 0;            
            text-align:center;
            padding:0px;
            vertical-align:middle ;
            over-flow: hidden;
            display:inline-block; 
            
            align: center;
        }
        
        div#foot {
        	position: fixed;
        	bottom: 0px;
            width: 600px;
        	overflow: auto;
        	height: 60px;
        	background-color: #EEEEEE;
        	clear: both;
            text-align:center;
        }
        
        .input {
        	position: absolute;
        	left: 10px;
        	right: 6px;
        	top: 5px;
            bottom: 5px;
        	overflow: auto;
        	height: 50px;
        	width: 480px;
        	text-align: left;
        	float: left;
            border-style: none;
            border-radius:4px;
            placeholder-size: 22px;            
            font-size: 22px;
        }
        
        .sendButton {
        	position: absolute;
        	top: 5px;
            bottom: 5px;
            right: 10px;
        	overflow: auto;
        	height: 52px;
        	width: 90px;
        	text-align: center;
        	float: right;
            border-radius:4px;
            background-color: #FFF;
            border-style: none;
            border-radius:4px;
            margin:auto;
            font-size: 22px;
        }
        
        .switchButton {
        	width: 320px;
        	height: 320px;
        	background: url(http://wa-ou.com/resources/images/products/qqlightapp-switch-button.png) no-repeat center center;
        	background-size: cover;
            border-radius:80px;
            border-style:none;
        }
        
        .switchButton:hover {
            background-color:#5788af;
            border:1px outset #2683cf;
            color:#fcffdf;
            padding:3px 3px 3px 3px;
            margin:1px;
            text-decoration:none;
            border-radius:80px;
        }
        
        .switchButton:active {
            background-color:#67b4cf;
            border:1px inset #1d659f;
            color:#e0ffaf;
            padding:4px 2px 2px 4px;
            margin:1px;
            text-decoration:none;
            border-radius:80px;
        }
        
        .line1 {
            position: absolute;
            left: 35px;
            color: gray;
            font-size: 28px;
        }
        .line2 {
            position: absolute;
            right: 35px;
            color: gray;
            font-size: 28px;
        }
        
         /* bubble style */
        .sender {
            clear:both;            
            padding: 30px 0px 0px 0px;
        }
        .sender div:nth-of-type(1) {
            float: left;
        }
        .sender div:nth-of-type(2) {
            background-color: #DDDDDD;
            float: left;
            margin: 0 10px 10px 15px;
            padding: 10px 10px 10px 0px;
            border-radius:7px;
            font-size: 28px;
        }
        .receiver div:first-child img, .sender div:first-child img {
            width:50px;
            height: 50px;
        }
        .receiver {
            clear:both;
        }
        .receiver div:nth-child(1) {
            float: right;
        }
        .receiver div:nth-of-type(2) {
            float:right;
            background-color: #DDDDDD;
            margin: 0 10px 10px 15px;
            padding: 10px 0px 10px 10px;
            border-radius:7px;
            font-size: 28px;
        }
        .left_triangle {
            height:0px;
            width:0px;
            border-width:8px;
            border-style:solid;
            border-color:transparent #DDDDDD transparent transparent;
            position: relative;
            left:-16px;
            top:3px;
        }
        .right_triangle {
            height:0px;
            width:0px;
            border-width:8px;
            border-style:solid;
            border-color:transparent transparent transparent #DDDDDD;
            position: relative;
            right:-16px;
            top:3px;
        }       
    </style>
</head>

<body>
    <div id="container">
        <div id="head"></div>
        
        <div id="middle">
            <button class="switchButton" id="switchButton"  onClick="clickSwitchButton()" ></button>
        </div>
        
        <div id="foot" >
            <datalist id="allGuideMessage">
              <option value="半小时后关灯">
              <option value="关闭呼吸灯">
              <option value="打开呼吸灯">
              <option value="明早6点开灯">
              <option value="晚上6点到8点开灯">
              <option value="12点关灯">
              <option value="胡说八戒">
            </datalist>
            <input class="input"  list="allGuideMessage" type="text" id="inputTextBox" placeholder="点击进行辅助输入" oninput="inputTextChange()"></input>
            <button class="sendButton" id="sendButton" disabled="disabled" onClick="clickSendButton()">发送</button>
        </div>
    </div>
    <script>
        function clickLine(obj) {
            document.getElementById("inputTextBox").value = obj;
            document.getElementById( "sendButton" ).removeAttribute("disabled");
        }
        
        function inputTextChange() {
        	var obj = document.getElementById( "inputTextBox" );
            if ( obj.value != "" ) {
            	document.getElementById( "sendButton" ).removeAttribute("disabled");
            } else {
            	document.getElementById( "sendButton" ).disabled = "disabled";
            }
        }
        
        function outInputMode() {
        }
        
        function clickSwitchButton() {
        	var o=document.getElementById("switchButton");
        	device.send({
        	    datapoint: [{
        	        id: 500001,
        	        apiName: 'click_switch',
        	        type: 'bytearray',
        	        value: 1
        	    }],
        	    vibrate: 1,
        	    onSuccess: function(ret) {
        	        device.log('onSuccess: ' + JSON.stringify(ret));
        	    },
        	    onError: function(ret) {
        	        device.log('onError: ' + JSON.stringify(ret));
        	    }
        	});
        }
        
        function pushMessageIntoHeadPanel( type, value ) {
        	 var head = document.getElementById("head");  
        	 if ( type == "sender" ) {
        		 head.appendChild( createSender(value) );	 
        	 } else if ( type == "receiver"){
        		 head.appendChild( createReceiver(value) );
        	 }
        	 
        	 head.scrollTop = head.scrollHeight;
        }
        
        function isNum(s)
        {
            if (s!=null && s!="")
            {
                return !isNaN(s);
            }
            return false;
        }
        
        function changeChineseToNumber( time ) {
        	
        	if ( isNum( time ) ) {
        		return Number(time);
        	}
        	
        	if ( time == "半" ) {
                time = 0.5;
            } else if ( time == "一" ) {
            	time = 1;
            } else if ( time == "二" ) {
                time = 2;
            } else if ( time == "三" ) {
                time = 3;
            } else if ( time == "四" ) {
                time = 4;
            } else if ( time == "五" ) {
                time = 5;
            } else if ( time == "六" ) {
                time = 6;
            } else if ( time == "七" ) {
                time = 7;
            } else if ( time == "八" ) {
                time = 8;
            } else if ( time == "九" ) {
                time = 9;
            } else if ( time == "十" ) {
                time = 10;
            } else if ( time == "十一" ) {
                time = 11;
            } else if ( time == "十二" ) {
                time = 12;
            } else if ( time == "十三" ) {
                time = 13;
            } else if ( time == "十四" ) {
                time = 14;
            } else if ( time == "十五" ) {
                time = 15;
            } else if ( time == "十六" ) {
                time = 16;
            } else if ( time == "十七" ) {
                time = 17;
            } else if ( time == "十八" ) {
                time = 18;
            } else if ( time == "十九" ) {
                time = 19;
            } else if ( time == "二十" ) {
                time = 20;
            } else if ( time == "二十一" ) {
                time = 21;
            } else if ( time == "二十二" ) {
                time = 22;
            } else if ( time == "二十三" ) {
                time = 23;
            } else if ( time == "二十四" ) {
                time = 24;
            } else if ( time == "二十五" ) {
                time = 25;
            } else if ( time == "二十六" ) {
                time = 26;
            } else if ( time == "二十七" ) {
                time = 27;
            } else if ( time == "二十八" ) {
                time = 28;
            } else if ( time == "二十九" ) {
                time = 29;
            } else if ( time == "三十" ) {
                time = 30;
            } else {
            	setTimeout( pushMessageIntoHeadPanel, 500, "receiver", "晕，这个数也太大了吧，你确定不是在戏弄我？" );
            	time = -1;
            }
        	
        	return time;
        }
        
        function sendDelayMessage( value ) {
        	
        	var pos = value.indexOf( "小时" );
        	var time = 0;
        	if ( pos > 0 ) {
        		time = value.substring( 0, pos );
        		time = changeChineseToNumber( time );
        		time = time * 60;
        	} else {
        		pos = value.indexof( "分钟" );
        		if ( pos > 0 ) {
        			time = value.subString( 0, pos );
        			time = changeChineseToNumber( time );
        		}
        	}
        	
        	var state = 0;
        	if ( value.indexOf( "开" ) > 0 ) {
        		state = 1;
        	}
        	
        	if ( time > 0 ) {
        		device.send({
                    datapoint: [{
                        id: 500002,
                        apiName: 'delay_switch',
                        type: 'bytearray',
                        value: [time,state]
                    }],
                    vibrate: 1,
                    onSuccess: function(ret) {
                        device.log('delay_switch onSuccess: ' + JSON.stringify(ret));
                        pushMessageIntoHeadPanel( "receiver", "好的!" );
                    },
                    onError: function(ret) {
                        device.log('onError: ' + JSON.stringify(ret));
                    }
                });
        	}
            
        }
        
        function sendBreathLightMessage( value ) {
        	var posTimeStringEnd = value.indexOf( "开" );
            var state = 1;
            if ( posTimeStringEnd < 0 ) {
                state = 0;
            }
            device.send({
                datapoint: [{
                    id: 500004,
                    apiName: 'breath_light_switch',
                    type: 'int32',
                    value: state
                }],
                vibrate: 1,
                onSuccess: function(ret) {
                    device.log('delay_switch onSuccess: ' + JSON.stringify(ret));
                    pushMessageIntoHeadPanel( "receiver", "好的!" );
                },
                onError: function(ret) {
                    device.log('onError: ' + JSON.stringify(ret));
                }
            });
        }
        
        function sendOnTimeSwitchMessage( value ) {
        	var posTimeStringBegin = value.indexOf( "下午" );

            var add12 = false;
        	if ( posTimeStringBegin < 0 ) {
        		posTimeStringBegin = value.indexOf( "晚上" );
        	}
        	if ( posTimeStringBegin >= 0 ) {
               add12 = true;
            } else {
            	posTimeStringBegin = value.indexOf( "早上" );
            	if ( posTimeStringBegin < 0 ) {
            		posTimeStringBegin = value.indexOf( "上午" );
            	}
            	if ( posTimeStringBegin < 0 ) {
                    posTimeStringBegin = value.indexOf( "早晨" );
                }
            } 
        	//alert( posTimeStringBegin );
        	if ( posTimeStringBegin >= 0 ) {
        		posTimeStringBegin = posTimeStringBegin + 2;
        	} else {
        		//没写下午什么什么，直接就是几点到几点
        		posTimeStringBegin = 0;
        	}
        	
        	var posTimeStringEnd = value.indexOf( "打开" );
        	var state = 1;
        	if ( posTimeStringEnd < 0 ) {
        		posTimeStringEnd = value.indexOf( "关" );
        		state = 0;
        	}
        	
        	if ( posTimeStringEnd < 0 ) {
        		//不是打开，不是关，那就是开灯
                posTimeStringEnd = value.indexOf( "开" );
            }
        	
        	var timeString = value.substring(posTimeStringBegin,posTimeStringEnd);
        	//alert( posTimeStringBegin + "," +  posTimeStringEnd +  "," + timeString );
        	var midStringPos = timeString.indexOf( "到" );
        	var timeBegin = timeString.substring(0, timeString.indexOf("点") );
        	timeBegin = changeChineseToNumber( timeBegin );
        	if ( timeBegin < 12 && add12 ) {
        		timeBegin = timeBegin + 12;
        	}
        	
        	timeString = timeString.substring( midStringPos + 1, timeString.length );
        	
        	var timeEnd = timeString.substring(0, timeString.indexOf("点") );
        	timeEnd = changeChineseToNumber( timeEnd );
        	if ( timeEnd < 12 && add12 ) {
        		timeEnd = timeEnd + 12;
            }
        	
        	//alert( timeBegin + "," + timeEnd );
        	
        	var myDate = new Date();
        	var hour = myDate.getHours();
        	var minute = myDate.getMinutes();
        	
        	device.send({
                datapoint: [{
                    id: 500003,
                    apiName: 'on_time_switch',
                    type: 'bytearray',
                    value: [hour,minute,timeBegin,timeEnd,state]
                }],
                vibrate: 1,
                onSuccess: function(ret) {
                    device.log('on_time_switch onSuccess: ' + JSON.stringify(ret));
                    pushMessageIntoHeadPanel( "receiver", "收到!" );
                },
                onError: function(ret) {
                    device.log('onError: ' + JSON.stringify(ret));
                }
            });
        }
        
        function isDelaySwitchMessage( value ) {
        	var r = new RegExp("后");
            return r.test( value );
        }
        
        function isOnTimeSwitchMessage( value ) {
        	var r = new RegExp("到");
            return r.test( value );
        }
        
        function isBreathLightControlMessage( value ) {
            var r = new RegExp("到");
            return r.test( value );
        }
        
        function inputisValid( value ) {
        	var r = new RegExp("开|关|打开|关闭|开灯|关灯");
        	return r.test( value );
        }
        
        function isBreathLightControlMessage( value ) {
            var r = new RegExp("呼吸灯");
            return r.test( value );
        }
        
        function clickSendButton() {
        	
        	var o = document.getElementById("inputTextBox");
        	
        	var sendValue = o.value;
        	pushMessageIntoHeadPanel( "sender", sendValue );
        	
        	o.value = "";
        	o.placeholder = "点击进行辅助输入";
        	
        	var ret = inputisValid( sendValue);
        	
        	if ( !inputisValid( sendValue) ) {
        		setTimeout( pushMessageIntoHeadPanel, 500, "receiver", "我暂时理解不了您说的话" );
        	} else {
        		if ( isDelaySwitchMessage( sendValue) ) {
        			sendDelayMessage( sendValue );
        		} else if ( isOnTimeSwitchMessage( sendValue ) ) {
        			sendOnTimeSwitchMessage( sendValue );
        		} else if ( isBreathLightControlMessage( sendValue ) ) {
        			 sendBreathLightMessage( sendValue );
                } else {
        			setTimeout( pushMessageIntoHeadPanel, 500, "receiver", "我暂时理解不了您说的话，我会努力学习的。" );
        		}
        	}
        }
    
    </script>
    <script src="http://qzonestyle.gtimg.cn/open/mobile/light_app/js/device.js"></script>
    <script>
        device.debug=true;  
        //Could be on,off,unknown
        switchCurrentState="unknown";
        
        
        function createReceiver( value ) {
        	var div = document.createElement("div");
        	
        	div.className = "receiver";
        	
        	
        	var imgDiv = document.createElement("div");
        	var img = document.createElement("img");
    
            imgDiv.appendChild( img );
        	img.src = "http://wa-ou.com/resources/images/products/qqlightapp-yong.png";
        	div.appendChild( imgDiv );
        	
        	var triangleContainer = document.createElement("div");
        	div.appendChild( triangleContainer );
    
            var triangle = document.createElement("div");
            triangleContainer.appendChild( triangle );
            triangle.className = "right_triangle";
            triangleContainer.innerHTML += "<span>" + value + "</span>";
            
            
        	return div;
        }
        
        function createSender( value ) {
            var div = document.createElement("div");
            
            div.className = "sender";
            
            
            var imgDiv = document.createElement("div");
            var img = document.createElement("img");
    
            imgDiv.appendChild( img );
            img.src = "http://wa-ou.com/resources/images/products/qqlightapp-switch-button.png";
            div.appendChild( imgDiv );
            
            var triangleContainer = document.createElement("div");
            div.appendChild( triangleContainer );
    
            var triangle = document.createElement("div");
            triangleContainer.appendChild( triangle );
            triangle.className = "left_triangle";
            triangleContainer.innerHTML += "<span>" + value + "</span>";
            triangleContainer.onclick = function() {
                clickLine(value);
            }
            return div;
        }
        
        function getCurrentSwitchState() {
        	device.query({
        	    list: [500010],
        	    onSuccess: function (ret) { // 查询成功回调
        	        device.log('onSuccess: ' + JSON.stringify(ret));
        	        ret.list.forEach(function (data) {
        	            switch (data.id) {
        	                case 500004:
        	                    device.showToast(data.val_list[0].val);
        	                    if ( data.val_list[0].val == 1 ) {
        	                    	switchCurrentState = "on";
        	                    } else {
        	                    	switchCurrentState = "off";
        	                    	device.log("现在开关是关闭状态")
        	                    }
        	                    break;
        	            }
        	        });
        	    },
        	    onError: function (ret) { // 查询失败回调
        	        device.log('onError: ' + JSON.stringify(ret));
        	    }
        	});
        }
        
        window.onload = function() {      
            var head = document.getElementById("head");        
            
            head.appendChild( createReceiver("我是主卧灯，您可以直接发信息给我。") );
            
            var m1 = createReceiver("点击输入框有提示");
            head.appendChild( m1 );
            getCurrentSwitchState();
        };
    </script>
    <!--[if !IE]>|xGv00|9905a873c2f7497c0c0cd7e24cc02554<![endif]-->
</body>
</html>
