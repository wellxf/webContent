<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta itemprop="name" content="挖藕智能科技轻app" />
    <meta itemprop="description" content="挖藕智能科技的qq物联轻app页面" />
    <meta itemprop="image" content="http://wa-ou.com/images/lightapp-logo.png" />
    <title>我的开关</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />
    <base />
    <style>
        html {
            -ms-text-size-adjust: 100%;
            -webkit-text-size-adjust: 100%;
            height: 100%
        }
        body {
        	font-family: "Microsoft Yahei", "\5FAE\8F6F\96C5\9ED1", arial, sans-serif;
            line-height: 1.6;
            height: 100%;
        }
        
        * {
        	margin: 0;
        	padding: 0
        }
        
        
        ul, ol {
        	padding-left: 0;
        	list-style-type: none
        }
        
        a {
        	text-decoration: none
        }
        
        div#container {
        	width: 100%;
            height: 100%;
        }
        
        div#head {
        	position: absolute;
        	width: 100%;
            height: 52%;
            border-style: solid;
            border-width: 0px 0px 1px 0px;
            overflow-y: scroll
        }
        
        div#middle {
        	position: absolute;
        	width: 100%;
            height: 40%;
        	bottom: 0;            
            text-align:center;
            padding:0px;
            over-flow: hidden;
            display:inline-block; 
            vertical-align:text-top;
        }
        
        div#foot {
        	position: fixed;
        	bottom: 0px;
            width: 100%;
        	overflow: auto;
        	height: 8%;
        	background-color: #EEEEEE;
        	clear: both;
            text-align:center;
            min-height:40px;
        }
        
        .input-select {
        	position: absolute;
        	width: 68%; 
        	float: left;
        	height: 80%;
        	
        	border:0px;
        	outline:0px;
        	font-size: 16px;
        	text-align: left;
        	left: 10px;
        	right: 6px;
        	top: 10%;
            bottom: 10%;
        }
        
        .input-input {        
        	position: absolute;
        	width: 60%; 
        	height: -80%;
        	float: left;
        	
        	border-style: none;
        	font-size: 16px;
        	text-align: left;
        	left: 12px;
        	right: 6px;
        	top: 15%;
            bottom: 18%;
        }
		
		    
        .sendButton {
        	position: absolute;
        	top: 10%;
            bottom: 10%;
            right: 10px;
        	overflow: auto;
        	height: 80%;
        	width: 20%;
        	text-align: center;
        	float: right;
            background-color: #FFF;
            border-style: none;
            border-radius:4px;
            margin:auto;
            font-size: 16px;
        }
        
        .switchButton {
            height: 80%;
        	background: url(http://wa-ou.com/resources/images/products/qqlightapp-switch-button.png) no-repeat center center;
        	background-size: cover;
            border-radius:80px;
            border-style:none;
        }
        
        .switchButton:hover {
            background-color:#5788af;
            border:1px outset #2683cf;
            color:#fcffdf;
            padding:3px 3px 3px 3px;
            margin:1px;
            text-decoration:none;
            border-radius:80px;
        }
        
        .switchButton:active {
            background-color:#67b4cf;
            border:1px inset #1d659f;
            color:#e0ffaf;
            padding:4px 2px 2px 4px;
            margin:1px;
            text-decoration:none;
            border-radius:80px;
        }
        
        .line1 {
            position: absolute;
            left: 35px;
            color: gray;
            font-size: 28px;
        }
        .line2 {
            position: absolute;
            right: 35px;
            color: gray;
            font-size: 28px;
        }
        
         /* bubble style */
        .sender {
            clear:both;            
            padding: 20px 0px 0px 0px;
        }
        .sender div:nth-of-type(1) {
            float: left;
        }
        .sender div:nth-of-type(2) {
            background-color: #DDDDDD;
            float: left;
            margin: 0 7px 7px 10px;
            padding: 7px 7px 7px 0px;
            border-radius:5px;
            font-size: 16px;
        }
        .receiver div:first-child img, .sender div:first-child img {
            width:33px;
            height: 33px;
        }
        .receiver {
            clear:both;
        }
        .receiver div:nth-child(1) {
            float: right;
        }
        .receiver div:nth-of-type(2) {
            float:right;
            background-color: #DDDDDD;
            margin: 0 7px 7px 10px;
            padding: 7px 0px 7px 7px;
            border-radius:5px;
            font-size: 16px;
        }
        .left_triangle {
            height:0px;
            width:0px;
            border-width:5px;
            border-style:solid;
            border-color:transparent #DDDDDD transparent transparent;
            position: relative;
            left:-10px;
            top:2px;
        }
        .right_triangle {
            height:0px;
            width:0px;
            border-width:5px;
            border-style:solid;
            border-color:transparent transparent transparent #DDDDDD;
            position: relative;
            right:-10px;
            top:2px;
        } 
   
    </style>
</head>

<body>
    <div id="container">
        <div id="head"></div>
        
        <div id="middle">
            <button class="switchButton" id="switchButton" style=""  onClick="clickSwitchButton()" ></button>
        </div>
        
        <div id="foot" >     
            <select  class="input-select"  id="inputTextSelect" onchange="setInputTextBoxValueAccordingtoSelect(this)" onClick="setInputTextBoxValueToFirstValue(this)">

			</select>
			<input class="input-input" id="inputTextBox" placeholder="点击进行辅助输入" oninput="inputTextChange()" onClick="inputFieldOnClick()"/>
            <button class="sendButton" id="sendButton" disabled="disabled" onClick="clickSendButton()">发送</button>
        </div>
    </div>
    <script>
        function clickLine(obj) {
            document.getElementById("inputTextBox").value = obj;
            document.getElementById( "sendButton" ).removeAttribute("disabled");
        }
        
        function setInputTextBoxValueAccordingtoSelect(obj) {
        	obj.nextElementSibling.value = obj.value;
        	inputTextChange();
        }
        
        function setInputTextBoxValueToFirstValue(obj) {
            if ( obj.nextElementSibling.value == "" ) {
            	obj.nextElementSibling.value = obj.value;
            	inputTextChange();
            } 
        }
        
        function inputFieldOnClick() {
        	var obj = document.getElementById("inputTextBox");
        	if ( obj.value.length == 0 ) {
        		var o = document.getElementById("inputTextSelect");
        		var event;
        	    event = document.createEvent('MouseEvents');
        	    event.initMouseEvent('mousedown', true, true, window);
        	    o.dispatchEvent(event);
        	}
        }
        
        function inputTextChange() {
        	var obj = document.getElementById( "inputTextBox" );
            if ( obj.value != "" ) {
            	document.getElementById( "sendButton" ).removeAttribute("disabled");
            } else {
            	document.getElementById( "sendButton" ).disabled = "disabled";
            }
        }
        
        function outInputMode() {
        }
        
        function clickSwitchButton() {
        	
        	var o=document.getElementById("switchButton");
        	var toSendId = 500001;
            waitingMessaegReplyID = toSendId;
            device.send({
                datapoint: [{
                    id: toSendId,
        	        apiName: 'set_data_point',
        	        type: 'int32',
        	        value: 1
        	    }],
        	    vibrate: 1,
        	    onSuccess: function(ret) {
        	    	if ( ret.charAt(0) == '0x00' ) {
        	    		head.appendChild( createReceiver("done（临时显示一下）") );
        	    	} else if ( ret.charAt(0) == '0x01' ) {
        	    		head.appendChild( createReceiver("失败了（临时显示一下）") );
        	    	} else {
        	    		head.appendChild( createReceiver("返回的是不是01也不是00（临时显示一下）") );
        	    	}
        	    },
        	    onError: function(ret) {
        	        device.log('onError: ' + JSON.stringify(ret));
        	    }
        	});

            //getCurrentSwitchState();
        }
        
        function pushMessageIntoHeadPanel( type, value ) {
        	 var head = document.getElementById("head");  
        	 if ( type == "sender" ) {
        		 head.appendChild( createSender(value) );	 
        	 } else if ( type == "receiver"){
        		 head.appendChild( createReceiver(value) );
        	 }
        	 
        	 head.scrollTop = head.scrollHeight;
        }
        
        function isNum(s)
        {
            if (s!=null && s!="")
            {
                return !isNaN(s);
            }
            return false;
        }
        
        function changeChineseToNumber( time ) {
        	
        	if ( isNum( time ) ) {
        		return Number(time);
        	}
        	
        	if (time == "半") {time = 0.5;} else if (time == "零") {time = 0;} else if (time == "一") {time = 1;} 
        	else if (time == "两") {time = 2;}else if (time == "二") {time = 2;} 
        	else if (time == "三") {time = 3;} else if (time == "四") {time = 4;} else if (time == "五") {time = 5;} 
        	else if (time == "六") {time = 6;} else if (time == "七") {time = 7;} else if (time == "八") {time = 8;} 
        	else if (time == "九") {time = 9;} else if (time == "十") {time = 10;} else if (time == "十一") {time = 11;} 
        	else if (time == "十二") {time = 12;} else if (time == "十三") {time = 13;} else if (time == "十四") {time = 14;} 
        	else if (time == "十五") {time = 15;} else if (time == "十六") {time = 16;} else if (time == "十七") {time = 17;} 
        	else if (time == "十八") {time = 18;} else if (time == "十九") {time = 19;} else if (time == "二十") {time = 20;} 
        	else if (time == "二十一") {time = 21;} else if (time == "二十二") {time = 22;} else if (time == "二十三") {time = 23;} 
        	else if (time == "二十四") {time = 24;} else if (time == "二十五") {time = 25;} else if (time == "二十六") {time = 26;} 
        	else if (time == "二十七") {time = 27;} else if (time == "二十八") {time = 28;} else if (time == "二十九") {time = 29;} 
        	else if (time == "三十") {time = 30;} 
			else if (time == "三十一") {time = 31;} else if (time == "三十二") {time = 32;} else if (time == "三十三") {time = 33;} 
			else if (time == "三十四") {time = 34;} else if (time == "三十五") {time = 35;} else if (time == "三十六") {time = 36;} 
			else if (time == "三十七") {time = 37;} else if (time == "三十八") {time = 38;} else if (time == "三十九") {time = 39;} 
			else if (time == "四十") {time = 40;} else if (time == "四十一") {time = 41;} else if (time == "四十二") {time = 42;} 
			else if (time == "四十三") {time = 43;} else if (time == "四十四") {time = 44;} else if (time == "四十五") {time = 45;} 
			else if (time == "四十六") {time = 46;} else if (time == "四十七") {time = 47;} else if (time == "四十八") {time = 48;} 
			else if (time == "四十九") {time = 49;} else if (time == "五十") {time = 50;} else if (time == "五十一") {time = 51;} 
			else if (time == "五十二") {time = 52;} else if (time == "五十三") {time = 53;} else if (time == "五十四") {time =54;} 
			else if (time == "五十五") {time = 55;} else if (time == "五十六") {time = 56;} else if (time == "五十七") {time = 57;} 
			else if (time == "五十八") {time = 58;} else if (time == "五十九") {time = 59;} else if (time == "六十") {time = 60;} 
            else {
            	setTimeout( pushMessageIntoHeadPanel, 500, "receiver", "这个数也太大,我识别不了" );
            	time = -1;
            }
        	
        	return time;
        }
        
        function beautyMinutes( minute ) {
        	if ( minute == 0 ) {
        		return "00";
        	} else {
        		return minute.toString();
        	}
        }
        function printDeviceLogFor500003( currentYear, currentMonth, currentDate, currentHour,currentMinute,timeBeginHour,timeBeginMinute,timeEndHour,timeEndMinute,repeatTime,state,startDayCount ) {
        	var deviceLog = "现在时间（20" + currentYear.toString() + "年" + currentMonth.toString() + "月" + currentDate + "日 " + currentHour.toString() + ":" + currentMinute.toString() + ") " ;

        	if ( state == 1 ) {
        		deviceLog = deviceLog + "开灯时间（" +　timeBeginHour.toString()　+　":" + beautyMinutes( timeBeginMinute ) + ") ";
        		if ( timeEndHour != 0xFF ) {
        			deviceLog = deviceLog + "关灯时间（" +　timeEndHour.toString()　+　":" + beautyMinutes( timeEndMinute ) + ") ";
            	}
        	} else {
        		deviceLog = deviceLog + "关灯时间（" +　timeBeginHour.toString()　+　":" + beautyMinutes( timeBeginMinute ) + ") ";
        		if ( timeEndHour != 0xFF ) {
        			deviceLog = deviceLog + "开灯时间（" +　timeEndHour.toString()　+　":" + beautyMinutes( timeEndMinute ) + ") ";
            	}
        	}
        	
        	if ( repeatTime == 0xFF ) {
        		deviceLog = deviceLog + " 重复次数: -1 (表示无限)";
        	} else {
        		deviceLog = deviceLog + " 重复次数: " + repeatTime.toString();
        	}
        	
        	if ( startDayCount == 1 ) {
        		deviceLog = deviceLog + " 从明天开始";
        	} else if ( startDayCount == 2 ) {
        		deviceLog = deviceLog + " 从后天开始";
        	} else if ( startDayCount != 0 ) {
        		deviceLog = deviceLog + " startDayCount不是1也不是2，代码错误";
        	}
        	device.log( deviceLog );
        }
        
        
        function sendDelayMessage( value ) {
        	value = value.replace( "个小时", "小时" );
        	value = value.replace( "个半小时", "小时30分钟" );
        	var pos = value.indexOf( "小时" );
    		
    		var myDate = new Date();
    		var currentYear = myDate.getFullYear() - 2000;
        	var currentMonth = myDate.getMonth() + 1;
        	var currentDate = myDate.getDate();
    		
        	var currentHour = myDate.getHours();
        	var currentMinute = myDate.getMinutes();
        	
        	var timeBeginHour = 0;
        	var timeBeginMinute = 0;
        	var timeEndHour = 0xFF;
        	var timeEndMinute = 0xFF;
        	var repeatTime = 1;
        	var startDayCount = 0;
        	
        	if ( pos > 0 ) {
        		timeBeginHour = value.substring( 0, pos );
        		timeBeginHour = changeChineseToNumber( timeBeginHour );     		
        	} 

        	var minutePos = value.indexOf( "分钟" );
            if ( minutePos > 0 ) {
                timeBeginMinute = value.substring( pos + 2, minutePos );
                timeBeginMinute = changeChineseToNumber( timeBeginMinute );
            }
        	
        	timeBeginMinute = timeBeginMinute + (timeBeginHour % 1) * 60;
        	timeBeginHour = parseInt( timeBeginHour );
        	
        	timeBeginMinute = timeBeginMinute + currentMinute;
        	if ( timeBeginMinute >= 60 ) {
        		timeBeginMinute = timeBeginMinute - 60;
        		timeBeginHour  = timeBeginHour + 1;
        	}
        	
        	timeBeginHour = timeBeginHour + currentHour;

    		if ( timeBeginHour >= 24 ) {
    			timeBeginHour = timeBeginHour % 24;
    		}
        	
        	var state = 0;
        	if ( value.indexOf( "开" ) > 0 ) {
        		state = 1;
        	}
        	

        	printDeviceLogFor500003( currentYear&0xFF, currentMonth&0xFF, currentDate&0xFF, currentHour&0xFF,currentMinute&0xFF,timeBeginHour&0xFF,timeBeginMinute&0xFF,timeEndHour&0xFF,timeEndMinute&0xFF,repeatTime&0xFF,state&0xFF, startDayCount&0xFF );

        	var toSendId = 500003;
        	waitingMessaegReplyID = toSendId;
        	device.send({
                datapoint: [{
                    id: toSendId,
                    apiName: 'set_data_point',
                    type: 'bytearray',
                    value: [currentYear&0xFF, currentMonth&0xFF, currentDate&0xFF,currentHour&0xFF,currentMinute&0xFF,timeBeginHour&0xFF,timeBeginMinute&0xFF,timeEndHour&0xFF,timeEndMinute&0xFF,repeatTime&0xFF,state&0xFF,startDayCount&0xFF]
                }],
                vibrate: 1,
                onSuccess: function(ret) {
                    device.log('on_time_switch onSuccess: ');
                    pushMessageIntoHeadPanel( "receiver", "收到!" );
                },
                onError: function(ret) {
                    device.log('onError: ' + JSON.stringify(ret));
                }
            });
            
        }
        
        function sendBreathLightMessage( value ) {
        	var posTimeStringEnd = value.indexOf( "开" );
            var state = 1;
            if ( posTimeStringEnd < 0 ) {
                state = 0;
            }
            var toSendId = 500004;
            waitingMessaegReplyID = toSendId;
            device.send({
                datapoint: [{
                    id: toSendId,
                    apiName: 'set_data_point',
                    type: 'int32',
                    value: state
                }],
                vibrate: 1,
                onSuccess: function(ret) {
                    device.log('delay_switch onSuccess: ' + JSON.stringify(ret));
                    pushMessageIntoHeadPanel( "receiver", "好的!" );
                },
                onError: function(ret) {
                    device.log('onError: ' + JSON.stringify(ret));
                }
            });
        }
        
        
        function getMinuteFromString(value) {
            var toHandled = value;

            var startPos = value.indexOf( "点" );
        	if ( startPos >= 0 ) {
        		toHandled = value.substring( startPos + 1, value.length );
        	}      
            
            if ( toHandled.indexOf( "分" ) > 0 ) {
            	toHandled = toHandled.substring( 0, toHandled.indexOf( "分" ) );
            }
            
            if ( toHandled == "半" ) {
                return 30;
            }  else if ( toHandled != "" ) {
            	return changeChineseToNumber( toHandled );
            } else {
            	return 0;
            }
        }
        
        function getHourFromString(value) {        	
        	var ret = value.substring(0, value.indexOf("点") );
            return changeChineseToNumber( ret );        	
        }
        
        function replaceAll(str, find, replace) {
        	if ( str.indexOf( find ) > 0 ) {
        		return str.replace(new RegExp(find, 'g'), replace);
        	} else {
        		return str;
        	}
    	}
        
        function sendOnTimeSwitchMessage( value ) {
        	value = value.replace( "明早", "明天早上" );
        	value = value.replace( "明晚", "明天晚上" );

        	value = replaceAll( value, ':', '点' );
        	value = replaceAll( value, '：', '点' );
        	//alert(value);
        	var timeBeginHour = -1;
        	var timeBeginMinute = 0;
        	var timeEndHour = -1;
        	var timeEndMinute = 0;
        	
        	var posTimeStringBegin = value.indexOf( "下午" );

            var add12 = false;
            var containMonitorOrAfternoon = false;
        	if ( posTimeStringBegin < 0 ) {
        		posTimeStringBegin = value.indexOf( "晚上" );
        	}
        	if ( posTimeStringBegin >= 0 ) {
               add12 = true;
            } else {
            	posTimeStringBegin = value.indexOf( "早上" );
            	if ( posTimeStringBegin < 0 ) {
            		posTimeStringBegin = value.indexOf( "上午" );
            	}
            	if ( posTimeStringBegin < 0 ) {
                    posTimeStringBegin = value.indexOf( "早晨" );
                }
            } 
        	
        	var repeatTime = 1;
        	var startDayCount = 0;
        	if ( value.indexOf( "明天" ) >= 0  ) {
        		repeatTime = 1;  
        		startDayCount = 1;
        	} else if ( value.indexOf( "后天" ) >= 0  ) {
        		repeatTime = 1;  
        		startDayCount = 2;
        	} else if ( value.indexOf( "每天" ) >= 0 ) {
                repeatTime = -1;
            }
        	
        	//alert( posTimeStringBegin );
        	if ( posTimeStringBegin >= 0 ) {
        		//这个containMonitorOrAfternoon后面用来判断12点开灯这种情况
        		containMonitorOrAfternoon = true;
        		//这里+2是为了越过早上、晚上等字符
        		posTimeStringBegin = posTimeStringBegin + 2;
        	} else {
        		//没写下午什么什么，直接就是几点到几点 或是明天几点到几点 或是每天几点到几点
        		posTimeStringBegin = value.indexOf( "明天" );
        		if ( posTimeStringBegin < 0 ) {
                    posTimeStringBegin = value.indexOf( "每天" );
                }
        		
        		if ( posTimeStringBegin < 0 ) {
                    posTimeStringBegin = value.indexOf( "后天" );
                }
        		
        		if (  posTimeStringBegin < 0 ) {
					//明天、每天、上下午、晚上、早晨都没有，就是几点到几点
            		posTimeStringBegin = 0;
        		} else {
        			//这是为了越过明天和每天这两个字符
        			posTimeStringBegin = posTimeStringBegin + 2;
        		}
        	}
        	
        	var posTimeStringEnd = value.indexOf( "打开" );
        	var state = 1;
        	if ( posTimeStringEnd < 0 ) {
        		posTimeStringEnd = value.indexOf( "关" );
        		state = 0;
        	}
        	
        	if ( posTimeStringEnd < 0 ) {
        		//不是打开，不是关，那就是开灯
                posTimeStringEnd = value.indexOf( "开" );
                state = 1;
            }
        	
        	var timeString = value.substring(posTimeStringBegin,posTimeStringEnd);
        	//alert( posTimeStringBegin + "," +  posTimeStringEnd +  "," + timeString );
        	
        	timeBeginHour = timeString.substring(0, timeString.indexOf("点") );
        	timeBeginHour = changeChineseToNumber( timeBeginHour );
        	
        	//////////////////////////////////////////////////////
        	// 获取当前时间，当前时间在解析十二点关灯这样的语句的时候用来判断是不是意思是24点  ///
        	//////////////////////////////////////////////////////
        	
        	var myDate = new Date();
        	var currentYear = myDate.getFullYear() - 2000;
        	var currentMonth = myDate.getMonth() + 1;
        	var currentDate = myDate.getDate();
        	var currentHour = myDate.getHours();
        	var currentMinute = myDate.getMinutes();
        	
        	var midStringPos = timeString.indexOf( "到" );
        	if ( midStringPos > 0 ) {
        		
                //处理起始时间的分钟值
                timeBeginMinute = getMinuteFromString( timeString.substring(0, midStringPos ) );
        		
        		timeString = timeString.substring( midStringPos + 1, timeString.length );
                
        		timeEndHour = getHourFromString( timeString );
        		timeEndMinute = getMinuteFromString( timeString );                
        		
                if ( timeEndHour <= 12 && add12 ) {
                	timeEndHour = timeEndHour + 12;
                }
        	} else {
        		//这不是几点到几点这样的语句，那么这就是十二点开灯这样的语句
        		
                timeBeginMinute = getMinuteFromString( timeString );
        		if ( timeBeginHour <= 12 && currentHour >=12 && (!containMonitorOrAfternoon) ) {
        			if ( currentHour < 12 + timeBeginHour || ( currentHour == 12 + timeBeginHour && currentMinute < timeBeginMinute ) ) {
                        add12 = true;
        			}
        		}
        		
        		if ( startDayCount > 0 && (!containMonitorOrAfternoon) ) {
        			//明天和后天这两种情况
        			add12 = false;
        		}
        	}
        	
        	if ( timeBeginHour <= 12 && add12 ) {
        		timeBeginHour = timeBeginHour + 12;
        	}
        	
        	if ( timeBeginHour == 24 ) {
        		timeBeginHour = 0;
        	}
	
        	if ( timeEndHour == 24 ) {
        		timeEndHour = 0;
        	}
        	
        	
        	//alert( timeBegin + "," + timeEnd );
        	
        	
        	printDeviceLogFor500003( currentYear&0xFF, currentMonth&0xFF, currentDate&0xFF, currentHour&0xFF,currentMinute&0xFF,timeBeginHour&0xFF,timeBeginMinute&0xFF,timeEndHour&0xFF,timeEndMinute&0xFF,repeatTime&0xFF,state&0xFF, startDayCount&0xFF );

        	var toSendId = 500003;
            waitingMessaegReplyID = toSendId;
            device.send({
                datapoint: [{
                    id: toSendId,
                    apiName: 'set_data_point',
                    type: 'bytearray',
                    value: [currentYear&0xFF, currentMonth&0xFF, currentDate&0xFF,currentHour&0xFF,currentMinute&0xFF,timeBeginHour&0xFF,timeBeginMinute&0xFF,timeEndHour&0xFF,timeEndMinute&0xFF,repeatTime&0xFF,state&0xFF,startDayCount&0xFF]
                }],
                vibrate: 1,
                onSuccess: function(ret) {
                    device.log('on_time_switch onSuccess: ');
                    pushMessageIntoHeadPanel( "receiver", "收到!" );
                },
                onError: function(ret) {
                    device.log('onError: ' + JSON.stringify(ret));
                }
            });
        }
        
        function isDelaySwitchMessage( value ) {
        	var r = new RegExp("后开|后关");
            return r.test( value );
        }
        
        function isOnTimeSwitchMessage( value ) {
        	var r = new RegExp("到|点开|分开|点关|分关|半关|半开");
            return r.test( value );
        }
        
        function isBreathLightControlMessage( value ) {
            var r = new RegExp("到");
            return r.test( value );
        }
        
        function inputisValid( value ) {
        	var r = new RegExp("开|关|打开|关闭|开灯|关灯");
        	return r.test( value );
        }
        
        function isBreathLightControlMessage( value ) {
            var r = new RegExp("呼吸灯");
            return r.test( value );
        }
        
        function clickSendButton() {
        	
        	var o = document.getElementById("inputTextBox");
        	
        	var sendValue = o.value;
        	pushMessageIntoHeadPanel( "sender", sendValue );
        	document.getElementById( "sendButton" ).disabled = "disabled";
        	o.value = "";
        	o.placeholder = "点击进行辅助输入";
        	
        	sendValue = sendValue.replace(/\s+/g, '');

        	sendValue = replaceAll( sendValue, '点钟', '点' );
        	sendValue = replaceAll( sendValue, '点整', '点' ); 
             
        	var ret = inputisValid( sendValue);
        	var validMessageSendSuccess = false;
        	if ( !inputisValid( sendValue) ) {
        		setTimeout( pushMessageIntoHeadPanel, 500, "receiver", "我暂时理解不了您说的话" );
        	} else {
        		if ( isDelaySwitchMessage( sendValue) ) {
        			sendDelayMessage( sendValue );
        			validMessageSendSuccess = true;
        		} else if ( isOnTimeSwitchMessage( sendValue ) ) {
        			sendOnTimeSwitchMessage( sendValue );
        			validMessageSendSuccess = true;
        		} else if ( isBreathLightControlMessage( sendValue ) ) {
        			 sendBreathLightMessage( sendValue );
        			 validMessageSendSuccess = true;
                } else {
        			setTimeout( pushMessageIntoHeadPanel, 500, "receiver", "我暂时理解不了您说的话，我会努力学习的。" );
        		}
        	}
        	
        	if ( validMessageSendSuccess ) {
        		addMessageIntoCookie( sendValue );
        	}
        }
    
    </script>
    <script src="http://qzonestyle.gtimg.cn/open/mobile/light_app/js/device.js"></script>
    <script>
        device.debug=true;  
        //Could be on,off,unknown
        switchCurrentState = "on";
        waitingMessaegReplyID = 500010;
        sendMessageInCookie = "";
        totalMessageSizeInCookie = 5;

    	cookieKey = "wa-ou-sent-message";
        
	    preDefinedMessages = ["晚上6点到8点开灯","12点关灯",
        		"后天11点关灯","明早5点开灯","每天6点到7点开灯","半小时后关灯","关闭呼吸灯","明早6点开灯"];
	    
	    allDetailedTestMessages = ["打开呼吸灯","关闭呼吸灯","12点半关灯","5点半关灯","五点半关灯","21点半关灯","9点半关灯",
	                               "晚上6点23分到8点27分开灯","晚上6点到8点27分开灯","晚上6点到8点五十七分开灯",
	                               "晚上6点到十点五十七开灯","二十点半到零点五十七开灯","12：30到12：50关灯",
	                               "12:30到12:50关灯","后天晚上9点到11点半开灯","半小时后关灯","一个半小时后关灯",
	                               "两个半小时后关灯","三个半小时后关灯","一小时50分钟后开灯","一小时一分钟后开灯","明早5点开灯",
	                               "明早5点三十分开灯","每天6点到7点开灯","每天6点20到7点50开灯","五点整开灯","晚上六点钟到8点钟开灯",
	                               "后天晚上六点钟到8点钟开灯","每天晚上六点钟到8点钟开灯"]
        
        function createReceiver( value ) {
        	var div = document.createElement("div");
        	
        	div.className = "receiver";
        	
        	
        	var imgDiv = document.createElement("div");
        	var img = document.createElement("img");
    
            imgDiv.appendChild( img );
        	img.src = "http://wa-ou.com/resources/images/products/qqlightapp-yong.png";
        	div.appendChild( imgDiv );
        	
        	var triangleContainer = document.createElement("div");
        	div.appendChild( triangleContainer );
    
            var triangle = document.createElement("div");
            triangleContainer.appendChild( triangle );
            triangle.className = "right_triangle";
            triangleContainer.innerHTML += "<span>" + value + "</span>";
            
            
        	return div;
        }
        
        function createSender( value ) {
            var div = document.createElement("div");
            
            div.className = "sender";
            
            
            var imgDiv = document.createElement("div");
            var img = document.createElement("img");
    
            imgDiv.appendChild( img );
            img.src = "http://wa-ou.com/resources/images/products/qqlightapp-switch-button.png";
            div.appendChild( imgDiv );
            
            var triangleContainer = document.createElement("div");
            div.appendChild( triangleContainer );
    
            var triangle = document.createElement("div");
            triangleContainer.appendChild( triangle );
            triangle.className = "left_triangle";
            triangleContainer.innerHTML += "<span>" + value + "</span>";
            triangleContainer.onclick = function() {
                clickLine(value);
            }
            return div;
        }
        
        function setGuideMessage() {
        	if ( switchCurrentState == "on" ) {
        		document.getElementById("allGuideMessage1").value = "半小时后关灯";
        	} else {
        		document.getElementById("allGuideMessage1").value = "半小时后开灯";
        	}
        }
        
        function receiveMessage() {
        	device.onReceive(function (data) {
                //device.log("enter into receiveMessage: " + JSON.stringify(data) + ", data.id = " + data.id );
                switch (data.id) {
                    case 500010:
                      //device.log( "data.value[0] = " + data.value[0] )
                      if ( data.value[0] == '0x11' ) {
                          device.log("现在灯是开的状态")
                          switchCurrentState = "on";
                      }  else if ( data.value[0] == '0x10' ) {
                          switchCurrentState = "off";
                          device.log("现在开关是关闭状态")
                      } else {
                          switchCurrentState = "on";
                      } 
                      setGuideMessage();
                    break;
                    case 500003:
                        if ( waitingMessaegReplyID == data.id ) {
                        	pushMessageIntoHeadPanel( "receiver", "收到!" );
                        } else {
                        	device.log( "waitingMessaegReplyID = " + waitingMessaegReplyID + ", but got: " + data.id );
                        }
                    break;
                    case 500004:
                        if ( waitingMessaegReplyID == data.id ) {
                          pushMessageIntoHeadPanel( "receiver", "好的，我记下了!" );
                        } else {
                        	device.log( "waitingMessaegReplyID = " + waitingMessaegReplyID + ", but got: " + data.id );
                        }
                    break;
                }
           });
        }
        
        function getCurrentSwitchState() {
        	var toSendId = 500010;
            waitingMessaegReplyID = toSendId;
            device.send({
                datapoint: [{
                    id: toSendId,
                    apiName: 'set_data_point',
                    type: 'int32',
                    value: 1
                }],
                vibrate: 1,
                onAck : function (ret) { 
                    //nothing
                    //go to receiveMessage
                }
            });
        	
        	//receiveMessage();
        } 
        
        function setSwitchButtonSize() {
        	var m = document.getElementById("middle");
        	var o = document.getElementById("switchButton");
        	var height = m.getBoundingClientRect().height * 0.8;

        	device.log( height );
        	if ( parseInt(height) < 180 ) {
        		height =  parseInt(height) * 0.95;
        	} else if ( parseInt(height) < 130 ) {
        		height =  parseInt(height) * 0.9;
        	} else if ( parseInt(height) < 100 ) {
        		height =  parseInt(height) * 0.7;
        	}
        	
        	o.style.width =  height + "px";
        	o.style.height = o.style.width;
        }

        function getCookie(name)
        {
	        var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
	        if(arr=document.cookie.match(reg)) {
		        return unescape(arr[2]);
	        }
	        else {
		        return "";
	        }
        }
        
        function setCookie(name,value)
        {
	        var Days = 30;
	        var exp = new Date();
	        exp.setTime(exp.getTime() + Days*24*60*60*1000);
	        document.cookie = name + "="+ escape (value) + ";expires=" + exp.toGMTString();
        }
        
        function addMessageIntoCookie( sendValue ) {
        	if ( sendMessageInCookie.length == 0 ) {
        		sendMessageInCookie = getCookie( cookieKey );
        	}
        	
        	var allMessages = sendMessageInCookie.split( ";" );
        	for ( var i = 0; i < allMessages.length; i++ ) {
        		if ( allMessages[i] == sendValue ) {
        			return;
        		}
        	}
        	
        	for ( var i = 0; i < preDefinedMessages.length - allMessages.length; i++ ) {
                if ( preDefinedMessages[i] == sendValue ) {
                    return;
                }
            }
        	

        	var messageLength = allMessages.length;
        	if ( messageLength >= totalMessageSizeInCookie ) {
        		messageLength = totalMessageSizeInCookie;
        	}
        	
        	for ( var i = messageLength - 1; i > 0 ; i-- ) {
    			allMessages[i] = allMessages[i-1];
    		}
        	
        	allMessages[0] = sendValue;
        	
        	sendMessageInCookie = "";
        	for ( var i = 0; i < allMessages.length; i++ ) {
        		if ( allMessages[i].length != 0 ) {
            		sendMessageInCookie = sendMessageInCookie + allMessages[i] + ";";
        		}
        	}
        	//alert( sendMessageInCookie );
        	setCookie( cookieKey, sendMessageInCookie );
        	setSelectOptions();
        }
        
        function setSelectOptions() {
        	var select = document.getElementById('inputTextSelect');
        	if ( sendMessageInCookie.length == 0 ) {
        		sendMessageInCookie = getCookie( cookieKey );
        	}
        	var allMessages = sendMessageInCookie.split( ";" );
			select.innerHTML = "";
			
	       	
	       	for ( var i = 0; i < allMessages.length; i++ ) {
	       		if ( allMessages[i].length > 0 ) {
	       			var opt = document.createElement('option');
	        	    opt.value = allMessages[i];
	        	    opt.innerHTML = allMessages[i];
	        	    select.appendChild(opt);
	       		}	       		
	       	}
	       	
	       	if ( device.debug ) {
	       		//调试模式有很复杂的消息
	       		preDefinedMessages = allDetailedTestMessages;
	       	}
	       	
	       	for ( var i = 0; i< preDefinedMessages.length - allMessages.length; i++ ){
        	    var opt = document.createElement('option');
        	    opt.value = preDefinedMessages[i];
        	    opt.innerHTML = preDefinedMessages[i];
        	    select.appendChild(opt);
        	}
	       	
        }
        
        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }
        
        function initGuideMessages() {
        	var deviceName = getParameterByName( "deviceRemark" );
        	var userName = getParameterByName( "userName" );
            if ( deviceName == "" ) {
                deviceName = "智能灯";
            }
            if ( userName != "" ) {
                head.appendChild( createReceiver("您好，" + userName + "！") );
            }
            setTimeout( pushMessageIntoHeadPanel, 300, "receiver", "我是" + deviceName + "，您可以直接发信息给我。" );
            setTimeout( pushMessageIntoHeadPanel, 300, "receiver", "点输入框有提示哦！");
        }
        
        window.onload = function() {      
            var head = document.getElementById("head");        
            setSwitchButtonSize();            
            receiveMessage();
            getCurrentSwitchState();
            //setCookie( cookieKey, "" );
            setSelectOptions();
            initGuideMessages();
        };
        
        // Listen for orientation changes
        window.addEventListener("orientationchange", function() {
        	setSwitchButtonSize();
        }, false);
        
    </script>
    <!--[if !IE]>|xGv00|9905a873c2f7497c0c0cd7e24cc02554<![endif]-->
</body>
</html>
