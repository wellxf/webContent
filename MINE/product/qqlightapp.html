<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta itemprop="name" content="挖藕智能科技轻app" />
    <meta itemprop="description" content="挖藕智能科技的qq物联轻app页面" />
    <meta itemprop="image" content="http://wa-ou.com/images/lightapp-logo.png" />
    <title>我的开关</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />
    <base />
    <style>
        html {
            -ms-text-size-adjust: 100%;
            -webkit-text-size-adjust: 100%;
            height: 100%
        }
        body {
        	font-family: "Microsoft Yahei", "\5FAE\8F6F\96C5\9ED1", arial, sans-serif;
            line-height: 1.6;
            height: 100%;
        }
        
        * {
        	margin: 0;
        	padding: 0
        }
        
        
        ul, ol {
        	padding-left: 0;
        	list-style-type: none
        }
        
        a {
        	text-decoration: none
        }
        
        div#container {
        	width: 100%;
            height: 100%;
        }
        
        div#head {
        	position: absolute;
        	width: 100%;
            height: 52%;
            border-style: solid;
            border-width: 0px 0px 1px 0px;
            overflow-y: scroll
        }
        
        div#middle {
        	position: absolute;
        	width: 100%;
            height: 40%;
        	bottom: 0;            
            text-align:center;
            padding:0px;
            over-flow: hidden;
            display:inline-block; 
            
            align: center;
        }
        
        div#foot {
        	position: fixed;
        	bottom: 0px;
            width: 100%;
        	overflow: auto;
        	height: 8%;
        	background-color: #EEEEEE;
        	clear: both;
            text-align:center;
            min-height:40px;
        }
        
        .input {
        	position: absolute;
        	left: 10px;
        	right: 6px;
        	top: 10%;
            bottom: 10%;
        	overflow: auto;
        	height: 80%;
        	width: 68%;
        	text-align: left;
        	float: left;
            border-style: none;
            border-radius:4px;
            placeholder-size: 22px;            
            font-size: 16px;
        }
        
        .sendButton {
        	position: absolute;
        	top: 10%;
            bottom: 10%;
            right: 10px;
        	overflow: auto;
        	height: 80%;
        	width: 20%;
        	text-align: center;
        	float: right;
            border-radius:4px;
            background-color: #FFF;
            border-style: none;
            border-radius:4px;
            margin:auto;
            font-size: 16px;
        }
        
        .switchButton {
        	width: 140px;
        	height: 140px;
            top: 5%;
            bottom: 5%;
        	background: url(http://wa-ou.com/resources/images/products/qqlightapp-switch-button.png) no-repeat center center;
        	background-size: cover;
            border-radius:80px;
            border-style:none;
        }
        
        .switchButton:hover {
            background-color:#5788af;
            border:1px outset #2683cf;
            color:#fcffdf;
            padding:3px 3px 3px 3px;
            margin:1px;
            text-decoration:none;
            border-radius:80px;
        }
        
        .switchButton:active {
            background-color:#67b4cf;
            border:1px inset #1d659f;
            color:#e0ffaf;
            padding:4px 2px 2px 4px;
            margin:1px;
            text-decoration:none;
            border-radius:80px;
        }
        
        .line1 {
            position: absolute;
            left: 35px;
            color: gray;
            font-size: 28px;
        }
        .line2 {
            position: absolute;
            right: 35px;
            color: gray;
            font-size: 28px;
        }
        
         /* bubble style */
        .sender {
            clear:both;            
            padding: 20px 0px 0px 0px;
        }
        .sender div:nth-of-type(1) {
            float: left;
        }
        .sender div:nth-of-type(2) {
            background-color: #DDDDDD;
            float: left;
            margin: 0 7px 7px 10px;
            padding: 7px 7px 7px 0px;
            border-radius:5px;
            font-size: 16px;
        }
        .receiver div:first-child img, .sender div:first-child img {
            width:33px;
            height: 33px;
        }
        .receiver {
            clear:both;
        }
        .receiver div:nth-child(1) {
            float: right;
        }
        .receiver div:nth-of-type(2) {
            float:right;
            background-color: #DDDDDD;
            margin: 0 7px 7px 10px;
            padding: 7px 0px 7px 7px;
            border-radius:5px;
            font-size: 16px;
        }
        .left_triangle {
            height:0px;
            width:0px;
            border-width:5px;
            border-style:solid;
            border-color:transparent #DDDDDD transparent transparent;
            position: relative;
            left:-10px;
            top:2px;
        }
        .right_triangle {
            height:0px;
            width:0px;
            border-width:5px;
            border-style:solid;
            border-color:transparent transparent transparent #DDDDDD;
            position: relative;
            right:-10px;
            top:2px;
        }       
    </style>
</head>

<body>
    <div id="container">
        <div id="head"></div>
        
        <div id="middle">
            <button class="switchButton" id="switchButton"  onClick="clickSwitchButton()" ></button>
        </div>
        
        <div id="foot" >
            <datalist id="allGuideMessage">
              <option id="allGuideMessage1" value="半小时后关灯">
              <option value="关闭呼吸灯">
              <option value="打开呼吸灯">
              <option value="明早6点开灯">
              <option value="晚上6点到8点开灯">
              <option value="12点关灯">
              <option value="胡说八戒">
            </datalist>
            <input class="input"  list="allGuideMessage" type="text" id="inputTextBox" placeholder="点击进行辅助输入" oninput="inputTextChange()"></input>
            <button class="sendButton" id="sendButton" disabled="disabled" onClick="clickSendButton()">发送</button>
        </div>
    </div>
    <script>
        function clickLine(obj) {
            document.getElementById("inputTextBox").value = obj;
            document.getElementById( "sendButton" ).removeAttribute("disabled");
        }
        
        function inputTextChange() {
        	var obj = document.getElementById( "inputTextBox" );
            if ( obj.value != "" ) {
            	document.getElementById( "sendButton" ).removeAttribute("disabled");
            } else {
            	document.getElementById( "sendButton" ).disabled = "disabled";
            }
        }
        
        function outInputMode() {
        }
        
        function clickSwitchButton() {
        	
        	var o=document.getElementById("switchButton");
        	var toSendId = 500001;
            waitingMessaegReplyID = toSendId;
            device.send({
                datapoint: [{
                    id: toSendId,
        	        apiName: 'set_data_point',
        	        type: 'int32',
        	        value: 1
        	    }],
        	    vibrate: 1,
        	    onSuccess: function(ret) {
        	    	if ( ret.charAt(0) == '0x00' ) {
        	    		head.appendChild( createReceiver("done（临时显示一下）") );
        	    	} else if ( ret.charAt(0) == '0x01' ) {
        	    		head.appendChild( createReceiver("失败了（临时显示一下）") );
        	    	} else {
        	    		head.appendChild( createReceiver("返回的是不是01也不是00（临时显示一下）") );
        	    	}
        	    },
        	    onError: function(ret) {
        	        device.log('onError: ' + JSON.stringify(ret));
        	    }
        	});

            //getCurrentSwitchState();
        }
        
        function pushMessageIntoHeadPanel( type, value ) {
        	 var head = document.getElementById("head");  
        	 if ( type == "sender" ) {
        		 head.appendChild( createSender(value) );	 
        	 } else if ( type == "receiver"){
        		 head.appendChild( createReceiver(value) );
        	 }
        	 
        	 head.scrollTop = head.scrollHeight;
        }
        
        function isNum(s)
        {
            if (s!=null && s!="")
            {
                return !isNaN(s);
            }
            return false;
        }
        
        function changeChineseToNumber( time ) {
        	
        	if ( isNum( time ) ) {
        		return Number(time);
        	}
        	
        	if (time == "半") {time = 0.5;} else if (time == "一") {time = 1;} else if (time == "二") {time = 2;} 
        	else if (time == "三") {time = 3;} else if (time == "四") {time = 4;} else if (time == "五") {time = 5;} 
        	else if (time == "六") {time = 6;} else if (time == "七") {time = 7;} else if (time == "八") {time = 8;} 
        	else if (time == "九") {time = 9;} else if (time == "十") {time = 10;} else if (time == "十一") {time = 11;} 
        	else if (time == "十二") {time = 12;} else if (time == "十三") {time = 13;} else if (time == "十四") {time = 14;} 
        	else if (time == "十五") {time = 15;} else if (time == "十六") {time = 16;} else if (time == "十七") {time = 17;} 
        	else if (time == "十八") {time = 18;} else if (time == "十九") {time = 19;} else if (time == "二十") {time = 20;} 
        	else if (time == "二十一") {time = 21;} else if (time == "二十二") {time = 22;} else if (time == "二十三") {time = 23;} 
        	else if (time == "二十四") {time = 24;} else if (time == "二十五") {time = 25;} else if (time == "二十六") {time = 26;} 
        	else if (time == "二十七") {time = 27;} else if (time == "二十八") {time = 28;} else if (time == "二十九") {time = 29;} 
        	else if (time == "三十") {time = 30;} 
            else {
            	setTimeout( pushMessageIntoHeadPanel, 500, "receiver", "这个数也太大,我识别不了" );
            	time = -1;
            }
        	
        	return time;
        }
        
        function beautyMinutes( minute ) {
        	if ( minute == 0 ) {
        		return "00";
        	} else {
        		return minute.toString();
        	}
        }
        function printDeviceLogFor500003( currentHour,currentMinute,timeBeginHour,timeBeginMinute,timeEndHour,timeEndMinute,repeatTime,state ) {
        	var deviceLog = "现在时间（" + currentHour.toString() + ":" + currentMinute.toString() + ") " ;

        	if ( state == 1 ) {
        		deviceLog = deviceLog + "开灯时间（" +　timeBeginHour.toString()　+　":" + beautyMinutes( timeBeginMinute ) + ") ";
        		if ( timeEndHour != -1 ) {
        			deviceLog = deviceLog + "关灯时间（" +　timeEndHour.toString()　+　":" + beautyMinutes( timeEndMinute ) + ") ";
            	}
        	} else {
        		deviceLog = deviceLog + "关灯时间（" +　timeBeginHour.toString()　+　":" + beautyMinutes( timeBeginMinute ) + ") ";
        		if ( timeEndHour != -1 ) {
        			deviceLog = deviceLog + "开灯时间（" +　timeEndHour.toString()　+　":" + beautyMinutes( timeEndMinute ) + ") ";
            	}
        	}
        	
        	deviceLog = deviceLog + " 重复次数: " + repeatTime.toString();
        	device.log( deviceLog );
        }
        
        
        function sendDelayMessage( value ) {
        	value = value.replace( "个小时", "小时" );
        	var pos = value.indexOf( "小时" );
    		
    		var myDate = new Date();
        	var currentHour = myDate.getHours();
        	var currentMinute = myDate.getMinutes();
        	
        	var timeBeginHour = 0;
        	var timeBeginMinute = 0;
        	var timeEndHour = -1;
        	var timeEndMinute = -1;
        	var repeatTime = 1;
        	
        	if ( pos > 0 ) {
        		timeBeginHour = value.substring( 0, pos );
        		timeBeginHour = changeChineseToNumber( timeBeginHour );     		
        	} else {
        		pos = value.indexof( "分钟" );
        		if ( pos > 0 ) {
        			timeBeginMinute = value.subString( 0, pos );
        			timeBeginMinute = changeChineseToNumber( time );
        		}
        	}
        	
        	timeBeginMinute = timeBeginMinute + (timeBeginHour % 1) * 60;
        	//timeBeginHour可能是0.5
        	timeBeginHour = parseInt( timeBeginHour );
        	
        	timeBeginMinute = timeBeginMinute + currentMinute;
        	if ( timeBeginMinute >= 60 ) {
        		timeBeginMinute = timeBeginMinute - 60;
        		timeBeginHour  = timeBeginHour + 1;
        	}
        	
        	timeBeginHour = timeBeginHour + currentHour;

    		if ( timeBeginHour >= 24 ) {
    			timeBeginHour = timeBeginHour % 24;
    		}
        	
        	var state = 0;
        	if ( value.indexOf( "开" ) > 0 ) {
        		state = 1;
        	}
        	
        	printDeviceLogFor500003( currentHour,currentMinute,timeBeginHour,timeBeginMinute,timeEndHour,timeEndMinute,repeatTime,state );

        	var toSendId = 500003;
        	waitingMessaegReplyID = toSendId;
        	device.send({
                datapoint: [{
                    id: toSendId,
                    apiName: 'set_data_point',
                    type: 'bytearray',
                    value: [currentHour,currentMinute,timeBeginHour,timeBeginMinute,timeEndHour,timeEndMinute,repeatTime,state]
                }],
                vibrate: 1,
                onSuccess: function(ret) {
                    device.log('on_time_switch onSuccess: ');
                    pushMessageIntoHeadPanel( "receiver", "收到!" );
                },
                onError: function(ret) {
                    device.log('onError: ' + JSON.stringify(ret));
                }
            });
            
        }
        
        function sendBreathLightMessage( value ) {
        	var posTimeStringEnd = value.indexOf( "开" );
            var state = 1;
            if ( posTimeStringEnd < 0 ) {
                state = 0;
            }
            var toSendId = 500004;
            waitingMessaegReplyID = toSendId;
            device.send({
                datapoint: [{
                    id: toSendId,
                    apiName: 'set_data_point',
                    type: 'int32',
                    value: state
                }],
                vibrate: 1,
                onSuccess: function(ret) {
                    device.log('delay_switch onSuccess: ' + JSON.stringify(ret));
                    pushMessageIntoHeadPanel( "receiver", "好的!" );
                },
                onError: function(ret) {
                    device.log('onError: ' + JSON.stringify(ret));
                }
            });
        }
        
        function sendOnTimeSwitchMessage( value ) {
        	value = value.replace( "明早", "明天早上" );
        	value = value.replace( "明晚", "明天晚上" );
        	//alert(value);
        	var timeBeginHour = -1;
        	var timeBeginMinute = 0;
        	var timeEndHour = -1;
        	var timeEndMinute = 0;
        	
        	var posTimeStringBegin = value.indexOf( "下午" );

            var add12 = false;
        	if ( posTimeStringBegin < 0 ) {
        		posTimeStringBegin = value.indexOf( "晚上" );
        	}
        	if ( posTimeStringBegin >= 0 ) {
               add12 = true;
            } else {
            	posTimeStringBegin = value.indexOf( "早上" );
            	if ( posTimeStringBegin < 0 ) {
            		posTimeStringBegin = value.indexOf( "上午" );
            	}
            	if ( posTimeStringBegin < 0 ) {
                    posTimeStringBegin = value.indexOf( "早晨" );
                }
            } 
        	
        	var repeatTime = 1;
        	if ( value.indexOf( "明天" ) > 0  ) {
        		repeatTime = 1;
        	}
        	
        	if ( value.indexOf( "每天" ) > 0 ) {
                repeatTime = -1;
            }
        	
        	//alert( posTimeStringBegin );
        	if ( posTimeStringBegin >= 0 ) {
        		posTimeStringBegin = posTimeStringBegin + 2;
        	} else {
        		//没写下午什么什么，直接就是几点到几点
        		posTimeStringBegin = 0;
        	}
        	
        	var posTimeStringEnd = value.indexOf( "打开" );
        	var state = 1;
        	if ( posTimeStringEnd < 0 ) {
        		posTimeStringEnd = value.indexOf( "关" );
        		state = 0;
        	}
        	
        	if ( posTimeStringEnd < 0 ) {
        		//不是打开，不是关，那就是开灯
                posTimeStringEnd = value.indexOf( "开" );
                state = 1;
            }
        	
        	var timeString = value.substring(posTimeStringBegin,posTimeStringEnd);
        	//alert( posTimeStringBegin + "," +  posTimeStringEnd +  "," + timeString );
        	
        	timeBeginHour = timeString.substring(0, timeString.indexOf("点") );
        	timeBeginHour = changeChineseToNumber( timeBeginHour );
        	if ( timeBeginHour < 12 && add12 ) {
        		timeBeginHour = timeBeginHour + 12;
        	}

        	var midStringPos = timeString.indexOf( "到" );
        	if ( midStringPos > 0 ) {
        		timeString = timeString.substring( midStringPos + 1, timeString.length );
                
        		timeEndHour = timeString.substring(0, timeString.indexOf("点") );
        		timeEndHour = changeChineseToNumber( timeEndHour );
                if ( timeEndHour < 12 && add12 ) {
                	timeEndHour = timeEndHour + 12;
                }
        	}
        	
        	
        	//alert( timeBegin + "," + timeEnd );
        	
        	var myDate = new Date();
        	var currentHour = myDate.getHours();
        	var currentMinute = myDate.getMinutes();
        	
        	printDeviceLogFor500003( currentHour,currentMinute,timeBeginHour,timeBeginMinute,timeEndHour,timeEndMinute,repeatTime,state );

        	var toSendId = 500003;
            waitingMessaegReplyID = toSendId;
            device.send({
                datapoint: [{
                    id: toSendId,
                    apiName: 'set_data_point',
                    type: 'bytearray',
                    value: [currentHour,currentMinute,timeBeginHour,timeBeginMinute,timeEndHour,timeEndMinute,repeatTime,state]
                }],
                vibrate: 1,
                onSuccess: function(ret) {
                    device.log('on_time_switch onSuccess: ');
                    pushMessageIntoHeadPanel( "receiver", "收到!" );
                },
                onError: function(ret) {
                    device.log('onError: ' + JSON.stringify(ret));
                }
            });
        }
        
        function isDelaySwitchMessage( value ) {
        	var r = new RegExp("后");
            return r.test( value );
        }
        
        function isOnTimeSwitchMessage( value ) {
        	var r = new RegExp("到|点开|分开|点关|分关");
            return r.test( value );
        }
        
        function isBreathLightControlMessage( value ) {
            var r = new RegExp("到");
            return r.test( value );
        }
        
        function inputisValid( value ) {
        	var r = new RegExp("开|关|打开|关闭|开灯|关灯");
        	return r.test( value );
        }
        
        function isBreathLightControlMessage( value ) {
            var r = new RegExp("呼吸灯");
            return r.test( value );
        }
        
        function clickSendButton() {
        	
        	var o = document.getElementById("inputTextBox");
        	
        	var sendValue = o.value;
        	pushMessageIntoHeadPanel( "sender", sendValue );
        	document.getElementById( "sendButton" ).disabled = "disabled";
        	o.value = "";
        	o.placeholder = "点击进行辅助输入";
        	
        	var ret = inputisValid( sendValue);
        	
        	if ( !inputisValid( sendValue) ) {
        		setTimeout( pushMessageIntoHeadPanel, 500, "receiver", "我暂时理解不了您说的话" );
        	} else {
        		if ( isDelaySwitchMessage( sendValue) ) {
        			sendDelayMessage( sendValue );
        		} else if ( isOnTimeSwitchMessage( sendValue ) ) {
        			sendOnTimeSwitchMessage( sendValue );
        		} else if ( isBreathLightControlMessage( sendValue ) ) {
        			 sendBreathLightMessage( sendValue );
                } else {
        			setTimeout( pushMessageIntoHeadPanel, 500, "receiver", "我暂时理解不了您说的话，我会努力学习的。" );
        		}
        	}
        }
    
    </script>
    <script src="http://qzonestyle.gtimg.cn/open/mobile/light_app/js/device.js"></script>
    <script>
        device.debug=true;  
        //Could be on,off,unknown
        switchCurrentState = "on";
        waitingMessaegReplyID = 500010;
        
        function createReceiver( value ) {
        	var div = document.createElement("div");
        	
        	div.className = "receiver";
        	
        	
        	var imgDiv = document.createElement("div");
        	var img = document.createElement("img");
    
            imgDiv.appendChild( img );
        	img.src = "http://wa-ou.com/resources/images/products/qqlightapp-yong.png";
        	div.appendChild( imgDiv );
        	
        	var triangleContainer = document.createElement("div");
        	div.appendChild( triangleContainer );
    
            var triangle = document.createElement("div");
            triangleContainer.appendChild( triangle );
            triangle.className = "right_triangle";
            triangleContainer.innerHTML += "<span>" + value + "</span>";
            
            
        	return div;
        }
        
        function createSender( value ) {
            var div = document.createElement("div");
            
            div.className = "sender";
            
            
            var imgDiv = document.createElement("div");
            var img = document.createElement("img");
    
            imgDiv.appendChild( img );
            img.src = "http://wa-ou.com/resources/images/products/qqlightapp-switch-button.png";
            div.appendChild( imgDiv );
            
            var triangleContainer = document.createElement("div");
            div.appendChild( triangleContainer );
    
            var triangle = document.createElement("div");
            triangleContainer.appendChild( triangle );
            triangle.className = "left_triangle";
            triangleContainer.innerHTML += "<span>" + value + "</span>";
            triangleContainer.onclick = function() {
                clickLine(value);
            }
            return div;
        }
        
        function setGuideMessage() {
        	if ( switchCurrentState == "on" ) {
        		document.getElementById("allGuideMessage1").value = "半小时后关灯";
        	} else {
        		document.getElementById("allGuideMessage1").value = "半小时后开灯";
        	}
        }
        
        function receiveMessage() {
        	device.onReceive(function (data) {
                //device.log("enter into receiveMessage: " + JSON.stringify(data) + ", data.id = " + data.id );
                switch (data.id) {
                    case 500010:
                      //device.log( "data.value[0] = " + data.value[0] )
                      if ( data.value[0] == '0x11' ) {
                          device.log("现在灯是开的状态")
                          switchCurrentState = "on";
                      }  else if ( data.value[0] == '0x10' ) {
                          switchCurrentState = "off";
                          device.log("现在开关是关闭状态")
                      } else {
                          switchCurrentState = "on";
                      } 
                      setGuideMessage();
                    break;
                    case 500003:
                        if ( waitingMessaegReplyID == data.id ) {
                        	pushMessageIntoHeadPanel( "receiver", "收到!" );
                        } else {
                        	device.log( "waitingMessaegReplyID = " + waitingMessaegReplyID + ", but got: " + data.id );
                        }
                    break;
                    case 500004:
                        if ( waitingMessaegReplyID == data.id ) {
                          pushMessageIntoHeadPanel( "receiver", "好的，我记下了!" );
                        } else {
                        	device.log( "waitingMessaegReplyID = " + waitingMessaegReplyID + ", but got: " + data.id );
                        }
                    break;
                }
           });
        }
        
        function getCurrentSwitchState() {
        	var toSendId = 500010;
            waitingMessaegReplyID = toSendId;
            device.send({
                datapoint: [{
                    id: toSendId,
                    apiName: 'set_data_point',
                    type: 'int32',
                    value: 1
                }],
                vibrate: 1,
                onAck : function (ret) { 
                    //nothing
                    //go to receiveMessage
                }
            });
        	
        	//receiveMessage();
        }
        
        window.onload = function() {      
            var head = document.getElementById("head");        
            
            head.appendChild( createReceiver("我是主卧灯，您可以直接发信息给我。") );
            
            var m1 = createReceiver("点击输入框有提示");
            head.appendChild( m1 );
            receiveMessage();
            getCurrentSwitchState();
        };
    </script>
    <!--[if !IE]>|xGv00|9905a873c2f7497c0c0cd7e24cc02554<![endif]-->
</body>
</html>
